<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Control Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    button {
      margin: 5px;
      padding: 10px;
      cursor: pointer;
    }

    pre {
      background: #f4f4f4;
      padding: 10px;
      border: 1px solid #ddd;
      overflow: auto;
      max-height: 500px;
    }

    .tab-container {
      margin: 20px 0;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ddd;
    }

    .tab-button {
      padding: 10px 20px;
      background: #f1f1f1;
      border: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }

    .tab-button.active {
      background: #007bff;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 20px;
      border: 1px solid #ddd;
      border-top: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .preview-container {
      display: flex;
      gap: 20px;
    }

    .preview-form {
      flex: 1;
    }

    .preview-result {
      flex: 1;
    }

    .section {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }

    .button-primary {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    #printerText {
      font-family: monospace;
    }
  </style>
</head>

<body>
  <h1>Mountain of Many Voices Control Panel</h1>

  <!-- Tab navigation -->
  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab(event, 'apps-tab')">
        Apps
      </button>
      <button class="tab-button" onclick="openTab(event, 'api-tab')">
        API Tests
      </button>
      <button class="tab-button" onclick="openTab(event, 'story-tab')">
        Story Tester
      </button>
    </div>

    <!-- Apps Tab -->
    <div id="apps-tab" class="tab-content active">
      <h2>Available Web Apps</h2>
      <div style="margin-bottom: 20px">
        <div style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
              gap: 15px;
            ">
          <a href="/station1" target="_blank" style="
                display: block;
                padding: 15px;
                background-color: #e9f5ff;
                border-radius: 5px;
                text-decoration: none;
                text-align: center;
                font-weight: bold;
                color: #0066cc;
              ">
            Station 1
          </a>
          <a href="/station2" target="_blank" style="
                display: block;
                padding: 15px;
                background-color: #e9f5ff;
                border-radius: 5px;
                text-decoration: none;
                text-align: center;
                font-weight: bold;
                color: #0066cc;
              ">
            Station 2
          </a>
          <a href="/editor/station1" target="_blank" style="
                display: block;
                padding: 15px;
                background-color: #fff0e9;
                border-radius: 5px;
                text-decoration: none;
                text-align: center;
                font-weight: bold;
                color: #cc6600;
              ">
            Editor (Station 1)
          </a>
          <a href="/editor/station2" target="_blank" style="
                display: block;
                padding: 15px;
                background-color: #fff0e9;
                border-radius: 5px;
                text-decoration: none;
                text-align: center;
                font-weight: bold;
                color: #cc6600;
              ">
            Editor (Station 2)
          </a>
        </div>
      </div>
    </div>

    <!-- API Tests Tab -->
    <div id="api-tab" class="tab-content">
      <h2>API Tests</h2>
      <div>
        <button onclick="testGetData()">Test GET /data</button>
        <button onclick="testPostData()">Test POST /data</button>
        <button onclick="testRecordChoice()">Test POST /record-choice</button>
        <button onclick="testGenerateDynamic()">
          Test POST /generate-dynamic
        </button>
        <button onclick="testCompilePlayable()">
          Test POST /editor/compile-playable
        </button>
        <button onclick="testSaveStoryJson()">
          Test POST /editor/save-story-json
        </button>
        <button onclick="testPrinter()">Test Printer</button>
      </div>

      <div class="section" style="margin-top: 20px">
        <h3>Printer Test</h3>
        <div class="form-group">
          <label for="printerText">Text to Print:</label>
          <textarea id="printerText" rows="5" placeholder="Enter text to print...">
            ╔═[Crazy CP437 Test]═══════╗
            ║ ☺☻♥♦♣♠•◘○ ♫☼►◄↕‼¶§       ║
            ║ ▬↨↑↓→←∟↔▲▼ !"#$%&'       ║
            ║ ()*+,-./0123456789:;<=>? ║
            ║ @ABCDEFGHIJKLMNO         ║
            ║ PQRSTUVWXYZ[\]^_         ║
            ║ `abcdefghijklmno         ║
            ║ pqrstuvwxyz{|}~ ⌂        ║
            ║ ÇüéâäàåçêëèïîìÄÅÉæÆôöò   ║
            ║ ûùÿÖÜ¢£¥₧ƒáíóúñÑªº¿⌐¬½¼  ║
            ║ ¡«»░▒▓│┤╡╢╖╕╣║╗╝╚╔╩╦     ║
            ║ ╠═╬╧╨╤╥╙╘╒╓╫╪┘┌█▄▌▐▀α    ║
            ║ βΓπΣσµτΦΘΩδ∞φε∩≡±≥≤¥     ║
            ╚══════════════════════════╝
            ░▒▓█  Some Funky Borders █▓▒░
           ±≥≤¥  Math symbols, just because.
          </textarea>
        </div>
        <button class="button-primary" onclick="testPrinter()">
          Print Text
        </button>
      </div>
    </div>

    <!-- Story Tester Tab -->
    <div id="story-tab" class="tab-content">
      <h2>Story API Tester</h2>
      <p>Test the Story Retriever API functions to fetch story data, compile texts, and more.</p>

      <!-- Function Tabs -->
      <div style="margin-bottom: 20px; border-bottom: 1px solid #ddd;">
        <div style="display: flex; gap: 5px; overflow-x: auto;">
          <button id="btnGetStoryBlocks" class="tab-button active" onclick="switchStoryFunction('getStoryBlocks', this)">getStoryBeforeBlockByPlayer</button>
          <button id="btnGetBlockData" class="tab-button" onclick="switchStoryFunction('getBlockData', this)">getBlockData</button>
          <button id="btnCompileStory" class="tab-button" onclick="switchStoryFunction('compileStory', this)">compileStoryForPlayer</button>
          <button id="btnChoiceSummary" class="tab-button" onclick="switchStoryFunction('choiceSummary', this)">compileChoiceSummaryForBlock</button>
        </div>
      </div>

      <!-- Function Parameter Sections -->
      <div class="section">
        <!-- Function description placeholders -->
        <div id="getStoryBlocksDesc">
          <div style="margin-bottom: 15px;">
            <strong>getStoryBeforeBlockByPlayer</strong>: Gets story blocks up to a specific block, optionally filtered by player and block type.
          </div>
        </div>
        <div id="getBlockDataDesc" style="display: none;">
          <div style="margin-bottom: 15px;">
            <strong>getBlockData</strong>: Retrieves a single block with all static and dynamic data for a specific block ID.
          </div>
        </div>
        <div id="compileStoryDesc" style="display: none;">
          <div style="margin-bottom: 15px;">
            <strong>compileStoryForPlayer</strong>: Compiles story text for a specific player, optionally up to a specific block.
          </div>
        </div>
        <div id="choiceSummaryDesc" style="display: none;">
          <div style="margin-bottom: 15px;">
            <strong>compileChoiceSummaryForBlock</strong>: Compiles a summary of player choices for a specific block.
          </div>
        </div>

        <!-- Parameters in row layout -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px;">
          <!-- Common Parameters -->
          <div class="form-group" id="storyIdGroup">
            <label for="storyTestStoryId">storyId:</label>
            <select id="storyTestStoryId">
              <option value="1">1 (Station 1)</option>
              <option value="2">2 (Station 2)</option>
              <option value="0">0 (Both Stories)</option>
            </select>
          </div>
          
          <div class="form-group" id="playerIdGroup">
            <label for="storyTestPlayerId">playerId:</label>
            <select id="storyTestPlayerId">
              <option value="">null (Anonymous)</option>
              <!-- Player IDs will be populated dynamically -->
            </select>
          </div>
          
          <!-- Get Story Blocks Parameters -->
          <div class="form-group" id="blockIdGroup">
            <label for="storyBlocksBlockId">blockId:</label>
            <select id="storyBlocksBlockId">
              <option value="">null (All Blocks)</option>
              <!-- Block IDs will be populated dynamically -->
            </select>
          </div>
          
          <div class="form-group" id="blockTypeGroup">
            <label for="storyBlocksType">blockType:</label>
            <select id="storyBlocksType">
              <option value="">null (All Types)</option>
              <option value="plain">plain</option>
              <option value="static">static</option>
              <option value="scene-header">scene-header</option>
              <option value="dynamic">dynamic</option>
            </select>
          </div>
          
          <!-- Get Block Data Parameters -->
          <div class="form-group" id="blockDataIdGroup" style="display: none;">
            <label for="blockDataBlockId">blockId:</label>
            <select id="blockDataBlockId" required>
              <!-- Block IDs will be populated dynamically -->
            </select>
          </div>
          
          <!-- Compile Story Parameters -->
          <div class="form-group" id="compileBlockIdGroup" style="display: none;">
            <label for="compileStoryBlockId">blockId:</label>
            <select id="compileStoryBlockId">
              <option value="">null (All Blocks)</option>
              <!-- Block IDs will be populated dynamically -->
            </select>
          </div>
          
          <!-- Choice Summary Parameters -->
          <div class="form-group" id="choiceSummaryIdGroup" style="display: none;">
            <label for="choiceSummaryBlockId">blockId:</label>
            <select id="choiceSummaryBlockId" required>
              <!-- Block IDs will be populated dynamically, filtered to only static blocks -->
            </select>
          </div>
        </div>

        <!-- Utilities Section -->
        <div style="margin-top: 15px;">
          <div class="button-group">
            <button class="button-primary" onclick="executeStoryTest()">Execute Function</button>
            <button onclick="copyStoryResultToClipboard()">Copy Result</button>
            <button onclick="loadPlayerIds()">Refresh Player List</button>
            <button onclick="loadStoryData()">Refresh Story Data</button>
          </div>
        </div>
      </div>

      <!-- Function Result -->
      <div class="section">
        <h3>Result</h3>
        <pre id="story-test-result" style="max-height: 500px; overflow: auto;">Results will appear here...</pre>
      </div>
    </div>

  </div>

  <h2>Response:</h2>
  <pre id="response"></pre>
  <script>
    // Tab navigation
    function openTab(evt, tabName) {
      // Hide all tab content
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }

      // Remove active class from all tab buttons
      const tabButtons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }

      // Show the selected tab and mark its button as active
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }


    // Update response display for API tests
    function updateResponse(data) {
      document.getElementById("response").textContent = JSON.stringify(
        data,
        null,
        2
      );
    }

    // API test functions
    function testGetData() {
      fetch("/data")
        .then((res) => res.json())
        .then((data) => updateResponse(data))
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    function testPostData() {
      fetch("/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sample: "data", timestamp: Date.now() }),
      })
        .then((res) => res.json())
        .then((data) => updateResponse(data))
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    function testRecordChoice() {
      fetch("/record-choice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          playerID: "testPlayer",
          blockUUID: "testBlock",
          blockType: "static",
          chosenIndex: 0,
          availableOptions: ["Option 1", "Option 2"],
          chosenText: "Option 1",
        }),
      })
        .then((res) => res.json())
        .then((data) => updateResponse(data))
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    function testGenerateDynamic() {
      fetch("/generate-dynamic", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: "Test dynamic generation",
          playerID: "testPlayer",
          blockUUID: "testBlock",
          instruction: "Test instruction",
          contextRefs: [],
          blockType: "dynamic-text",
        }),
      })
        .then((res) => res.json())
        .then((data) => updateResponse(data))
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    function testCompilePlayable() {
      // Use station1 as the default station
      fetch("/editor/compile-playable/station1", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          blocks: [{ type: "plain", text: "Sample text" }],
        }),
      })
        .then((res) => res.text())
        .then((data) => updateResponse({ html: data }))
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    function testSaveStoryJson() {
      // Use station1 as the default station
      fetch("/editor/save-story-json/station1", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          blocks: [{ type: "plain", text: "Sample story" }],
        }),
      })
        .then((res) => res.json())
        .then((data) => updateResponse(data))
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    function testPrinter() {
      const text = document.getElementById("printerText").value;

      fetch("/print", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text }),
      })
        .then((res) => res.json())
        .then((data) => {
          updateResponse(data);
          if (data.success) {
            document.getElementById("response").textContent =
              "✅ " + data.message;
          }
        })
        .catch((err) => updateResponse({ error: err.toString() }));
    }

    // Initialize the form fields on page load
    document.addEventListener("DOMContentLoaded", function () {
      updateFormFields();
      initializeStoryTester();
    });

    // ------- Story Tester Functions -------

    // Cached data for dropdowns
    let allBlocks = [];
    let playerIds = [];
    let staticBlocks = [];
    let currentStoryFunction = 'getStoryBlocks';

    // Initialize story tester forms
    async function initializeStoryTester() {
      // Set up story ID change listener
      document.getElementById('storyTestStoryId').addEventListener('change', loadStoryData);

      // Initial data load
      await Promise.all([
        loadPlayerIds(),
        loadStoryData()
      ]);
    }

    // Switch between different story functions
    function switchStoryFunction(functionName, buttonElement) {
      // Update current function
      currentStoryFunction = functionName;
      
      // Update active button styling
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      buttonElement.classList.add('active');
      
      // Hide all parameter sections
      document.getElementById('getStoryBlocksDesc').style.display = 'none';
      document.getElementById('getBlockDataDesc').style.display = 'none';
      document.getElementById('compileStoryDesc').style.display = 'none';
      document.getElementById('choiceSummaryDesc').style.display = 'none';
      
      // Hide all specific parameter groups
      document.getElementById('blockIdGroup').style.display = 'none';
      document.getElementById('blockTypeGroup').style.display = 'none';
      document.getElementById('blockDataIdGroup').style.display = 'none';
      document.getElementById('compileBlockIdGroup').style.display = 'none';
      document.getElementById('choiceSummaryIdGroup').style.display = 'none';
      
      // Common parameters visibility
      document.getElementById('storyIdGroup').style.display = 'block';
      document.getElementById('playerIdGroup').style.display = 'block';
      
      // Show function-specific parameters
      switch (functionName) {
        case 'getStoryBlocks':
          document.getElementById('getStoryBlocksDesc').style.display = 'block';
          document.getElementById('blockIdGroup').style.display = 'block';
          document.getElementById('blockTypeGroup').style.display = 'block';
          break;
          
        case 'getBlockData':
          document.getElementById('getBlockDataDesc').style.display = 'block';
          document.getElementById('blockDataIdGroup').style.display = 'block';
          break;
          
        case 'compileStory':
          document.getElementById('compileStoryDesc').style.display = 'block';
          document.getElementById('compileBlockIdGroup').style.display = 'block';
          break;
          
        case 'choiceSummary':
          document.getElementById('choiceSummaryDesc').style.display = 'block';
          document.getElementById('storyIdGroup').style.display = 'none'; // No storyId for choice summary
          document.getElementById('playerIdGroup').style.display = 'none'; // No playerId for choice summary
          document.getElementById('choiceSummaryIdGroup').style.display = 'block';
          break;
      }
    }

    // Load player IDs for dropdown
    async function loadPlayerIds() {
      try {
        const response = await fetch('/data');
        const data = await response.json();
        
        if (data && data.players) {
          playerIds = Object.keys(data.players);
          
          // Populate player ID dropdown
          const playerSelect = document.getElementById('storyTestPlayerId');
          
          // Clear existing options except the first one
          while (playerSelect.options.length > 1) {
            playerSelect.remove(1);
          }
          
          // Add player IDs
          playerIds.forEach(playerId => {
            const option = document.createElement('option');
            option.value = playerId;
            option.textContent = playerId;
            playerSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading player IDs:', error);
        document.getElementById('story-test-result').textContent = `Error loading player IDs: ${error.message}`;
      }
    }

    // Load story blocks based on selected story ID
    async function loadStoryData() {
      try {
        document.getElementById('story-test-result').textContent = 'Loading story data...';
        const storyId = document.getElementById('storyTestStoryId').value;
        
        // Fetch story blocks
        const response = await fetch(`/story/blocks?storyId=${storyId}`);
        const data = await response.json();
        
        if (data && data.success && data.blocks) {
          allBlocks = data.blocks;
          staticBlocks = allBlocks.filter(block => block.type === 'static');
          
          // Populate block ID dropdowns
          populateBlockDropdowns();
          document.getElementById('story-test-result').textContent = `Loaded ${allBlocks.length} blocks from story ${storyId}, including ${staticBlocks.length} static blocks.`;
        }
      } catch (error) {
        console.error('Error loading story data:', error);
        document.getElementById('story-test-result').textContent = `Error loading story data: ${error.message}`;
      }
    }

    // Populate all block ID dropdowns
    function populateBlockDropdowns() {
      // Function to populate a specific dropdown
      function populateDropdown(selectId, blocks, includeEmptyOption = true) {
        const select = document.getElementById(selectId);
        
        // Clear existing options
        select.innerHTML = '';
        
        // Add empty option if needed
        if (includeEmptyOption) {
          const emptyOption = document.createElement('option');
          emptyOption.value = '';
          emptyOption.textContent = 'null (All Blocks)';
          select.appendChild(emptyOption);
        }
        
        // Add block options
        blocks.forEach(block => {
          const option = document.createElement('option');
          option.value = block.id;
          
          // Create a descriptive label
          let label = `${block.id.substring(0, 8)}... (${block.type})`;
          
          // Add more context based on block type
          if (block.type === 'plain' && block.text) {
            label += `: "${block.text.substring(0, 20)}${block.text.length > 20 ? '...' : ''}"`;
          } else if (block.type === 'static' && block.options) {
            label += `: [${block.options.join(', ')}]`;
          } else if (block.type === 'scene-header' && block.titleName) {
            label += `: ${block.titleName}`;
          }
          
          option.textContent = label;
          select.appendChild(option);
        });
      }
      
      // Populate all dropdowns
      populateDropdown('storyBlocksBlockId', allBlocks, true);
      populateDropdown('blockDataBlockId', allBlocks, false);
      populateDropdown('compileStoryBlockId', allBlocks, true);
      populateDropdown('choiceSummaryBlockId', staticBlocks, false);
    }

    // Execute the selected story function
    async function executeStoryTest() {
      try {
        const storyId = document.getElementById('storyTestStoryId').value;
        const playerId = document.getElementById('storyTestPlayerId').value;
        let url = '';
        
        // Show loading state
        document.getElementById('story-test-result').textContent = 'Loading...';
        
        switch (currentStoryFunction) {
          case 'getStoryBlocks': {
            const blockId = document.getElementById('storyBlocksBlockId').value;
            const blockType = document.getElementById('storyBlocksType').value;
            
            // Build URL with query parameters
            url = `/story/blocks?storyId=${storyId}`;
            if (playerId) url += `&playerId=${playerId}`;
            if (blockId) url += `&blockId=${blockId}`;
            if (blockType) url += `&blockType=${blockType}`;
            break;
          }
          
          case 'getBlockData': {
            const blockId = document.getElementById('blockDataBlockId').value;
            if (!blockId) {
              throw new Error('Block ID is required');
            }
            
            url = `/story/block/${blockId}`;
            if (playerId) url += `?playerId=${playerId}`;
            break;
          }
          
          case 'compileStory': {
            const blockId = document.getElementById('compileStoryBlockId').value;
            
            url = `/story/compile?storyId=${storyId}`;
            if (playerId) url += `&playerId=${playerId}`;
            if (blockId) url += `&blockId=${blockId}`;
            break;
          }
          
          case 'choiceSummary': {
            const blockId = document.getElementById('choiceSummaryBlockId').value;
            if (!blockId) {
              throw new Error('Block ID is required');
            }
            
            url = `/story/choices/${blockId}`;
            break;
          }
        }
        
        // Make API request
        const response = await fetch(url);
        const data = await response.json();
        
        // Display result
        document.getElementById('story-test-result').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        console.error('Error executing story test:', error);
        document.getElementById('story-test-result').textContent = `Error: ${error.message}`;
      }
    }

    // Copy story test result to clipboard
    function copyStoryResultToClipboard() {
      const resultText = document.getElementById('story-test-result').textContent;
      navigator.clipboard
        .writeText(resultText)
        .then(() => {
          alert("Results copied to clipboard!");
        })
        .catch((err) => {
          alert("Failed to copy: " + err);
        });
    }
  </script>
</body>

</html>