<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Story Player - Station 2</title>
    <link rel="stylesheet" href="/shared/story-player.css" />
    <script
      defer
      src="https://unpkg.com/alpinejs@3.11.1/dist/cdn.min.js"
    ></script>
    <style>
      /* Override the transition time specifically for static options */
      .static-option {
        transition: opacity 3s ease, background-color 0.2s ease,
          border-color 0.2s ease;
      }
      
      /* Codename verification styles */
      #codename-verification {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #191b21;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      
      .codename-form {
        width: 80%;
        max-width: 400px;
        padding: 20px;
        border: 1px dotted #69801d;
        text-align: center;
        margin-bottom: 30px;
      }
      
      .codename-form h2 {
        font-size: 18px;
        margin-bottom: 20px;
      }
      
      .codename-form input {
        width: 80%;
        padding: 10px;
        margin: 15px 0;
        background-color: #232530;
        color: #eaeaea;
        border: 1px solid #666;
        font-family: "CP437Courier", "FusionPixelFont", sans-serif;
        font-size: 16px;
        text-align: center;
      }
      
      .codename-form button {
        padding: 8px 16px;
        background-color: transparent;
        color: #69801d;
        border: 1px dotted #69801d;
        cursor: pointer;
        font-family: "CP437Courier", "FusionPixelFont", sans-serif;
        font-size: 14px;
        margin-top: 10px;
      }
      
      .codename-form .error-message {
        color: #ff6b6b;
        margin-top: 10px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- Codename verification overlay - displayed before story starts -->
    <div id="codename-verification">
      <div class="codename-form">
        <h2>输入你的代号以继续</h2>
        <p>在第一站结束时，你已获得一个代号。</p>
        <input type="text" id="codename-input" placeholder="请输入你在第一站获得的代号" />
        <div id="error-message" class="error-message"></div>
        <button id="verify-button">确认</button>
      </div>
    </div>
    
    <div id="story-container">
      <!-- Story player will be initialized here after codename verification -->
      <div id="player-data"></div>
      <div id="passage-container">
        <!-- Passages will be rendered here -->
      </div>
      <div id="status-bar"></div>
    </div>

    <script src="/shared/story-player.js"></script>
    
    <script>
      // Station 2 codename verification script
      let validatedPlayerId = null;
      
      // Handle codename verification
      document.addEventListener("DOMContentLoaded", () => {
        const serverUrl = "http://localhost:3001";
        const verifyButton = document.getElementById("verify-button");
        const codenameInput = document.getElementById("codename-input");
        const errorMessage = document.getElementById("error-message");
        const verificationOverlay = document.getElementById("codename-verification");
        
        verifyButton.addEventListener("click", () => {
          const codename = codenameInput.value.trim();
          
          if (!codename) {
            errorMessage.textContent = "请输入代号";
            return;
          }
          
          console.log("Verifying codename:", codename);
          
          // Verify codename with server
          fetch(`${serverUrl}/validate-codename`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codename })
          })
          .then(response => {
            console.log("Response status:", response.status);
            return response.json();
          })
          .then(data => {
            console.log("Validation response:", data);
            
            if (data.valid === true) {
              console.log("Valid codename, player ID:", data.playerId);
              
              // Make sure playerId exists
              if (!data.playerId) {
                console.error("Error: Player ID missing from response");
                errorMessage.textContent = "验证失败，缺少玩家ID";
                return;
              }
              
              // Store the validated player ID
              validatedPlayerId = data.playerId;
              
              // Hide verification overlay
              verificationOverlay.style.display = "none";
              
              // Initialize Alpine.js with the story player
              initializeStoryPlayer();
            } else {
              // Invalid codename
              errorMessage.textContent = data.message || "代号无效，请重试";
            }
          })
          .catch(error => {
            console.error("Error verifying codename:", error);
            errorMessage.textContent = "验证失败，请重试";
          });
        });
        
        // Also allow pressing Enter to submit
        codenameInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            verifyButton.click();
          }
        });
      });
      
      // Initialize Alpine.js story player after verification
      function initializeStoryPlayer() {
        // Initialize Alpine.js with the storyPlayer component
        document.querySelector("#story-container").innerHTML = `
          <div x-data="storyPlayer" x-init="init()">
            <div id="player-data"></div>
            <div id="passage-container">
              <!-- Passages will be rendered here -->
            </div>
            <div id="status-bar" x-text="'Story Player ID: ' + config.playerId"></div>
          </div>
        `;
        
        // Override the default player ID with our validated one
        document.addEventListener("alpine:init", () => {
          Alpine.data("storyPlayer", () => ({
            // Override config with our validated player ID
            config: {
              serverUrl: "http://localhost:3001",
              playerId: validatedPlayerId,
              storyPath: "input/story.json",
              debug: false,
              stationId: "station2"
            },
            
            // The rest of the storyPlayer methods are defined in story-player.js
          }));
        });
        
        // Force a re-evaluation of Alpine.js
        window.dispatchEvent(new CustomEvent('alpine:init'));
        
        // Reinitialize Alpine.js
        if (window.Alpine) {
          window.Alpine.initTree(document.body);
        }
      }
    </script>
  </body>
</html>