<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Story Player - Station 2</title>
    <link rel="stylesheet" href="/shared/story-player.css" />
    <script
      defer
      src="https://unpkg.com/alpinejs@3.11.1/dist/cdn.min.js"
    ></script>
    <style>
      /* Override the transition time specifically for static options */
      .static-option {
        transition: opacity 3s ease, background-color 0.2s ease,
          border-color 0.2s ease;
      }
      
      /* Codename verification styles */
      #codename-verification {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #191b21;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      
      .codename-form {
        width: 90%;
        max-width: 800px;
        padding: 20px;
        border: 1px dotted #69801d;
        text-align: center;
        margin-bottom: 30px;
      }
      
      .codename-form h2 {
        font-size: 18px;
        margin-bottom: 20px;
      }
      
      .codename-selection {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        margin: 20px 0;
      }
      
      .codename-column {
        display: flex;
        flex-direction: column;
        width: 30%;
      }
      
      .codename-button {
        padding: 8px;
        margin: 4px 0;
        background-color: #232530;
        color: #eaeaea;
        border: 1px solid #666;
        cursor: pointer;
        font-family: "CP437Courier", "FusionPixelFont", sans-serif;
        font-size: 16px;
      }
      
      .codename-button.selected {
        background-color: #3a3f52;
        border: 1px solid #69801d;
      }
      
      .codename-preview {
        font-size: 20px;
        margin: 20px 0;
        padding: 10px;
        background-color: #232530;
        color: #eaeaea;
        border: 1px solid #666;
        font-family: "CP437Courier", "FusionPixelFont", sans-serif;
        display: inline-block;
        min-width: 200px;
      }
      
      .codename-form button {
        padding: 8px 16px;
        background-color: transparent;
        color: #69801d;
        border: 1px dotted #69801d;
        cursor: pointer;
        font-family: "CP437Courier", "FusionPixelFont", sans-serif;
        font-size: 14px;
        margin-top: 10px;
      }
      
      .codename-form .error-message {
        color: #ff6b6b;
        margin-top: 10px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- Codename verification overlay - displayed before story starts -->
    <div id="codename-verification">
      <div class="codename-form">
        <h2>选择你的代号以继续</h2>
        <p>在第一站结束时，你已获得一个代号。请从以下选项中选择你的代号。</p>
        
        <div id="codename-selection" class="codename-selection">
          <div class="codename-column" id="first-column">
            <!-- First component buttons will be generated here -->
          </div>
          <div class="codename-column" id="second-column">
            <!-- Second component buttons will be generated here -->
          </div>
          <div class="codename-column" id="third-column">
            <!-- Third component buttons will be generated here -->
          </div>
        </div>
        
        <div class="codename-preview" id="codename-preview">_____</div>
        
        <div id="error-message" class="error-message"></div>
        <button id="verify-button" disabled>确认</button>
      </div>
    </div>
    
    <div id="story-container">
      <!-- Story player will be initialized here after codename verification -->
      <div id="player-data"></div>
      <div id="passage-container">
        <!-- Passages will be rendered here -->
      </div>
      <div id="status-bar"></div>
    </div>

    <script src="/shared/story-player.js"></script>
    
    <script>
      // Station 2 codename verification script
      let validatedPlayerId = null;
      
      // Handle codename verification
      document.addEventListener("DOMContentLoaded", () => {
        const serverUrl = "http://localhost:3001";
        const verifyButton = document.getElementById("verify-button");
        const errorMessage = document.getElementById("error-message");
        const verificationOverlay = document.getElementById("codename-verification");
        const codenamePreview = document.getElementById("codename-preview");
        const firstColumn = document.getElementById("first-column");
        const secondColumn = document.getElementById("second-column");
        const thirdColumn = document.getElementById("third-column");
        
        // Selected components
        let selectedComponents = {
          first: null,
          second: null,
          third: null
        };
        
        // Load codename components from server
        fetch(`${serverUrl}/utils/codeNameComponents.json`)
          .then(response => response.json())
          .then(components => {
            // Populate first column
            components.first.forEach(component => {
              const button = createComponentButton(component, "first");
              firstColumn.appendChild(button);
            });
            
            // Populate second column
            components.second.forEach(component => {
              const button = createComponentButton(component, "second");
              secondColumn.appendChild(button);
            });
            
            // Populate third column
            components.third.forEach(component => {
              const button = createComponentButton(component, "third");
              thirdColumn.appendChild(button);
            });
          })
          .catch(error => {
            console.error("Error loading codename components:", error);
            errorMessage.textContent = "加载代号组件失败";
          });
        
        // Create component button
        function createComponentButton(component, type) {
          const button = document.createElement("button");
          button.textContent = component;
          button.className = "codename-button";
          button.dataset.component = component;
          button.dataset.type = type;
          
          button.addEventListener("click", () => {
            // Deselect previous button in this column
            if (selectedComponents[type]) {
              document.querySelectorAll(`.codename-button[data-type="${type}"].selected`).forEach(btn => {
                btn.classList.remove("selected");
              });
            }
            
            // Select this button
            button.classList.add("selected");
            selectedComponents[type] = component;
            
            // Update preview
            updateCodenamePreview();
            
            // Enable submit button if all components selected
            if (selectedComponents.first && selectedComponents.second && selectedComponents.third) {
              verifyButton.disabled = false;
            }
          });
          
          return button;
        }
        
        // Update codename preview
        function updateCodenamePreview() {
          let preview = "";
          
          if (selectedComponents.first) {
            preview += selectedComponents.first;
          } else {
            preview += "_";
          }
          
          if (selectedComponents.second) {
            preview += selectedComponents.second;
          } else {
            preview += "_";
          }
          
          if (selectedComponents.third) {
            preview += selectedComponents.third;
          } else {
            preview += "_";
          }
          
          codenamePreview.textContent = preview;
        }
        
        // Handle verify button click
        verifyButton.addEventListener("click", () => {
          // Build complete codename
          const codename = selectedComponents.first + selectedComponents.second + selectedComponents.third;
          
          console.log("Verifying codename:", codename);
          
          // Verify codename with server
          fetch(`${serverUrl}/validate-codename`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ codename })
          })
          .then(response => {
            console.log("Response status:", response.status);
            return response.json();
          })
          .then(data => {
            console.log("Validation response:", data);
            
            if (data.valid === true) {
              console.log("Valid codename, player ID:", data.playerId);
              
              // Make sure playerId exists
              if (!data.playerId) {
                console.error("Error: Player ID missing from response");
                errorMessage.textContent = "验证失败，缺少玩家ID";
                return;
              }
              
              // Store the validated player ID
              validatedPlayerId = data.playerId;
              
              // Hide verification overlay
              verificationOverlay.style.display = "none";
              
              // Initialize Alpine.js with the story player
              initializeStoryPlayer();
            } else {
              // Invalid codename
              errorMessage.textContent = data.message || "代号无效，请重试";
            }
          })
          .catch(error => {
            console.error("Error verifying codename:", error);
            errorMessage.textContent = "验证失败，请重试";
          });
        });
      });
      
      // Initialize Alpine.js story player after verification
      function initializeStoryPlayer() {
        // Very simple approach - directly override the player ID in the story-player.js
        window.VALIDATED_PLAYER_ID = validatedPlayerId;
        
        // Initialize Alpine.js with the storyPlayer component
        document.querySelector("#story-container").innerHTML = `
          <div x-data="storyPlayer" x-init="init()">
            <div id="player-data"></div>
            <div id="passage-container">
              <!-- Passages will be rendered here -->
            </div>
            <div id="status-bar" x-text="'Story Player ID: ' + config.playerId"></div>
          </div>
        `;
        
        console.log("Story player initialized with player ID:", validatedPlayerId);
      }
    </script>
  </body>
</html>