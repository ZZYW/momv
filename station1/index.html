<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Twine-like Story with Automatic Jungian AI Extension</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 0 10px;
        line-height: 1.6;
      }
      .section {
        display: none;
        margin-bottom: 20px;
      }
      .active {
        display: block;
      }
      .choice-btn {
        display: inline-block;
        margin: 5px;
        padding: 6px 12px;
        border: 1px solid #333;
        background: #eee;
        cursor: pointer;
        font-size: 1em;
      }
      .choice-btn:hover {
        background: #ddd;
      }
    </style>
  </head>
  <body>
    <!-- Section 1: Narrative with Choice 1 -->
    <div id="section1" class="section active">
      <h2>第一章. 出发</h2>
      <p>
        在一个幽静的村子里，被无情的时间行进遗忘了，
        小吴又找到了自己。现年30岁的他，更像是从前的自己，
        而不是曾经在街上游荡的男孩，他回来了。
      </p>
      <p>
        2024年的第一天，家中充满了三大姑八大姨们的闲聊交响乐，
        嗡嗡作响着对他孤独生活的轻快哀叹，就像一张被遗忘的老唱片。
      </p>
      <p>
        关于他【1.
        <span class="choice-btn" onclick="makeChoice(1, '未婚')">未婚</span>
        <span class="choice-btn" onclick="makeChoice(1, '待业')">待业</span>
        <span class="choice-btn" onclick="makeChoice(1, '下岗')">下岗</span>】
        的生活，每一个笑话都在空气中飘荡，就像红塔山香烟冒出的烟一样空灵和短暂。
      </p>
    </div>

    <!-- Section 2: Narrative with Choice 2 -->
    <div id="section2" class="section">
      <p>
        小吴的身体和记忆漂流到童年的怀抱中，就像一只【2.
        <span class="choice-btn" onclick="makeChoice(2, '梨花猫')">梨花猫</span>
        <span class="choice-btn" onclick="makeChoice(2, '老鼠')">老鼠</span>
        <span class="choice-btn" onclick="makeChoice(2, '土狗')">土狗</span>】
        偷偷溜进了老房子被遗忘的角落。他发现自己几乎漫无目的地向那座红色的山走去——
        一个沉默、神秘的实体，在他不上不下，不老不小，不男不女，不土不洋的背景中若隐若现。
      </p>
    </div>

    <!-- Section 3: Narrative with Choice 3 -->
    <div id="section3" class="section">
      <p>
        设计院是小学同学李媛媛的家，她家小区墙上的标语是【3.
        <span class="choice-btn" onclick="makeChoice(3, '少生孩子多种树')"
          >少生孩子多种树</span
        >
        <span
          class="choice-btn"
          onclick="makeChoice(3, '时间就是金钱，效率就是生命')"
          >时间就是金钱，效率就是生命</span
        >
        <span class="choice-btn" onclick="makeChoice(3, '爱护环境，人人有责')"
          >爱护环境，人人有责</span
        >】。
      </p>
    </div>

    <!-- Section 4: Final Narrative with Automatic AI Insertion -->
    <div id="section4" class="section">
      <p>
        马路对面，小吴上过的中学传来的眼保健操旋律， 唤起了他遥远的童年记忆。
        <span id="ai-result"></span>
      </p>
    </div>

    <script>
      // Object to store player's choices.
      const userChoices = {
        choice1: null,
        choice2: null,
        choice3: null,
      };

      let currentSection = 1;
      let aiCalled = false; // Ensure we only call the AI once.

      // Records the player's choice and moves to the next section.
      function makeChoice(choiceNumber, value) {
        userChoices["choice" + choiceNumber] = value;
        nextSection();
      }

      // Transitions to the next narrative section.
      function nextSection() {
        document
          .getElementById("section" + currentSection)
          .classList.remove("active");
        currentSection++;
        const nextSectionEl = document.getElementById(
          "section" + currentSection
        );
        if (nextSectionEl) {
          nextSectionEl.classList.add("active");
          // If we are on section 4, automatically call the AI.
          if (currentSection === 4 && !aiCalled) {
            aiCalled = true;
            sendToLLM();
          }
        }
      }

      // Returns the full original story containing all options.
      function getFullStory() {
        return `
第一章. 出发。
在一个幽静的村子里，被无情的时间行进遗忘了，
小吴又找到了自己。现年30岁的他，更像是从前的自己，
而不是曾经在街上游荡的男孩，他回来了。

2024年的第一天，家中充满了三大姑八大姨们的闲聊交响乐，
嗡嗡作响着对他孤独生活的轻快哀叹，就像一张被遗忘的老唱片。
关于他的生活，有以下几种可能：【未婚 / 待业 / 下岗】。

小吴的身体和记忆漂流到童年的怀抱中，就像一只【梨花猫 / 老鼠 / 土狗】
偷偷溜进了老房子被遗忘的角落。他向那座红色的山缓缓走去——
一个沉默、神秘的实体，在他不上不下，不老不小，不男不女，不土不洋的背景中若隐若现。

设计院是小学同学李媛媛的家，她家小区墙上的标语可能是：【少生孩子多种树 / 时间就是金钱，效率就是生命 / 爱护环境，人人有责】。

马路对面，小吴上过的中学传出眼保健操的旋律，
唤起了他遥远的童年记忆。
      `;
      }

      // Returns a summary of the player's choices.
      function getPlayerChoicesSummary() {
        return `
玩家选择如下：
选项1：${userChoices.choice1}
选项2：${userChoices.choice2}
选项3：${userChoices.choice3}
      `;
      }

      // Calls the backend LLM service with the provided prompt.
      async function askLLM(prompt) {
        try {
          const response = await fetch("http://localhost:3000/ai", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message: prompt }),
          });
          const data = await response.json();
          return data;
        } catch (e) {
          console.error("Error contacting the AI service:", e);
          return {
            analysis: "Error",
            "new-writing": "Error contacting the AI service.",
          };
        }
      }

      // Constructs the prompt and sends it to the LLM automatically.
      async function sendToLLM() {
        const fullStory = getFullStory();
        const choicesSummary = getPlayerChoicesSummary();
        const promptTemplate = `
请根据以下完整故事和玩家选择生成一段新的文字。
原始故事（包含所有选项）：
${fullStory}

玩家实际选择：
${choicesSummary}

请运用荣格心理学框架解释这些选择中的象征意义和潜意识内涵，
然后写出一句新文字，反映这些内在符号及其意义，
并以JSON格式返回，其中 JSON 中必须包含 "analysis" 和 "new-writing" 两个键。
      `;

        // Optional: you can show a temporary "loading" text.
        document.getElementById("ai-result").textContent = "正在生成……";

        const reply = await askLLM(promptTemplate);

        try {
          // If the backend already returns JSON, we assume it contains the required keys.
          let result = reply;
          // If the response is a string, try parsing it.
          if (typeof reply === "string") {
            result = JSON.parse(reply);
          }
          document.getElementById("ai-result").textContent =
            result["new-writing"] || "未返回新文字.";
        } catch (e) {
          console.error("Error parsing the AI response:", e);
          document.getElementById("ai-result").textContent =
            "解析 AI 返回结果时出错.";
        }
      }
    </script>
  </body>
</html>
