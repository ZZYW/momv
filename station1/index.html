<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Interactive Story Player - Station 1</title>
    <style>
      body {
        font-family: serif;
        margin: 0 auto;
        padding: 20px;
        max-width: 800px;
        background-color: #f9f9f9;
        line-height: 1.6;
      }
      .passage {
        display: none;
        padding: 20px;
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .passage.active {
        display: block;
      }
      .plain {
        display: block;
        margin-bottom: 15px;
        font-size: 18px;
      }
      .static-option-container {
        margin: 15px 0;
      }
      .static-option {
        display: block;
        padding: 10px;
        margin: 8px 0;
        cursor: pointer;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition: all 0.2s ease;
      }
      .static-option:hover {
        background-color: #f0f0f0;
      }
      .static-option.selected {
        background: #e6f7ff;
        border-color: #1890ff;
        font-weight: bold;
      }
      .static-option.faded {
        opacity: 0.3;
      }
      .dynamic-container {
        margin: 15px 0;
        padding: 15px;
        border-left: 3px solid #ccc;
        background-color: #f9f9f9;
      }
      .dynamic-text-result {
        font-style: italic;
        font-size: 18px;
      }
      .dynamic-word {
        font-weight: bold;
        border-bottom: 1px dotted #666;
      }
      .next-link {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 16px;
        background-color: #1890ff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
      }
      .next-link:hover {
        background-color: #096dd9;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.2);
        border-radius: 50%;
        border-top-color: #1890ff;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      #status-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 10px;
        background-color: #f8f8f8;
        border-top: 1px solid #ddd;
        font-size: 12px;
        text-align: center;
        color: #666;
      }
      .error {
        color: red;
        padding: 20px;
        text-align: center;
        font-weight: bold;
      }
      h2 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <div id="player-data"></div>
    <div id="passage-container"></div>
    <div id="status-bar"></div>
    <script>
      (function () {
        // Configuration and Initialization
        const SERVER_URL = window.location.origin.replace(/:\d+$/, ":3001");
        const playerID =
          "player_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substring(2, 9);
        document.getElementById("status-bar").innerText =
          "Story Player ID: " + playerID;

        let projectBlocks = [];
        let passages = [];
        let currentPassageIndex = 0;

        // Load the story JSON
        fetch("input/story1.json")
          .then((response) => response.json())
          .then((data) => {
            if (data.blocks && Array.isArray(data.blocks)) {
              projectBlocks = data.blocks;
              init();
            } else {
              document.getElementById("passage-container").innerHTML =
                "<div class='error'>Error: Invalid story data</div>";
            }
          })
          .catch((error) => {
            console.error("Error loading story:", error);
            document.getElementById("passage-container").innerHTML =
              "<div class='error'>Error loading story. Please make sure story1.json exists.</div>";
          });

        function init() {
          groupBlocksIntoPassages();
          renderPassage(0);
          const firstPassage = document.getElementById("passage-0");
          if (firstPassage) firstPassage.classList.add("active");
          loadDynamicContent();
        }

        // Group blocks into passages based on scene headers.
        function groupBlocksIntoPassages() {
          let current = [];
          projectBlocks.forEach((block) => {
            if (block.type === "scene-header" && current.length > 0) {
              passages.push(current);
              current = [];
            }
            current.push(block);
          });
          if (current.length > 0) passages.push(current);
        }

        // Render a passage with its blocks.
        function renderPassage(passageIndex) {
          if (passageIndex >= passages.length) return;

          const container = document.getElementById("passage-container");
          const blocks = passages[passageIndex];
          const passageEl = document.createElement("div");
          passageEl.className = "passage";
          passageEl.id = "passage-" + passageIndex;

          blocks.forEach((block) => {
            const blockEl = document.createElement("div");
            blockEl.className = "block-" + block.type;
            blockEl.style.marginBottom = "20px";
            switch (block.type) {
              case "plain":
                blockEl.innerHTML =
                  '<div class="plain">' + (block.text || "") + "</div>";
                break;
              case "static":
                if (Array.isArray(block.options)) {
                  const opts = block.options.map(
                    (opt, i) =>
                      `<div class="static-option" data-idx="${i}" onclick="selectOption(this, '${block.id}', 'static')">${opt}</div>`
                  );
                  blockEl.innerHTML = `<div class="static-option-container">${opts.join(
                    ""
                  )}</div>`;
                }
                break;
              case "dynamic-option":
                blockEl.innerHTML = `
                  <div class="dynamic-container">
                    <div class="loading-indicator">Loading dynamic options... <span class="loading"></span></div>
                    <div class="dynamic-options-container" data-uuid="${block.id}"></div>
                  </div>`;
                break;
              case "dynamic-text":
                blockEl.innerHTML = `
                  <div class="dynamic-container">
                    <div class="loading-indicator">Generating text... <span class="loading"></span></div>
                    <div class="dynamic-text-container" data-uuid="${block.id}"></div>
                  </div>`;
                break;
              case "dynamic-word":
                blockEl.innerHTML = `
                  <div class="dynamic-container">
                    <div class="loading-indicator">Generating word... <span class="loading"></span></div>
                    <div class="dynamic-word-container" data-uuid="${block.id}"></div>
                  </div>`;
                break;
              case "scene-header":
                blockEl.innerHTML = `<h2>${block.titleName || "Scene"}</h2>`;
                break;
            }
            passageEl.appendChild(blockEl);
          });

          // Add Continue link or End message.
          if (passageIndex < passages.length - 1) {
            const link = document.createElement("div");
            link.innerHTML = `<a href="#" class="next-link" onclick="goToNextPassage(${passageIndex})">Continue</a>`;
            passageEl.appendChild(link);
          } else {
            const end = document.createElement("div");
            end.style.marginTop = "30px";
            end.style.textAlign = "center";
            end.style.fontStyle = "italic";
            end.innerText = "The End";
            passageEl.appendChild(end);
          }

          container.appendChild(passageEl);
        }

        // Helper to handle option selection (static or dynamic)
        window.selectOption = function (elem, blockID, type) {
          const container = elem.parentElement;
          const allOpts = container.querySelectorAll(".static-option");
          allOpts.forEach((o) => {
            o.classList.add("faded");
            o.onclick = null;
          });
          elem.classList.remove("faded");
          elem.classList.add("selected");
          const chosenText = elem.textContent;
          const chosenIndex =
            type === "static" ? parseInt(elem.dataset.idx) : undefined;

          fetch(SERVER_URL + "/record-choice", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              playerID,
              blockUUID: blockID,
              blockType: type,
              chosenIndex: chosenIndex,
              chosenText,
              availableOptions: Array.from(allOpts).map((x) => x.textContent),
            }),
          });
        };

        // Load dynamic content for dynamic blocks.
        function loadDynamicContent() {
          const containers = [
            { selector: ".dynamic-options-container", type: "dynamic-option" },
            { selector: ".dynamic-text-container", type: "dynamic-text" },
            { selector: ".dynamic-word-container", type: "dynamic-word" },
          ];
          containers.forEach(({ selector, type }) => {
            document.querySelectorAll(selector).forEach((c) => {
              fetchDynamicBlock(c.dataset.uuid, type, c);
            });
          });
        }

        function fetchDynamicBlock(blockID, blockType, container) {
          const blockData = projectBlocks.find((b) => b.id === blockID);
          if (!blockData) {
            container.innerText = "No block data found";
            return;
          }
          const loadingIndicator = container
            .closest(".dynamic-container")
            .querySelector(".loading-indicator");
          fetch(SERVER_URL + "/generate-dynamic", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: blockData.prompt || "No prompt",
              playerID,
              blockUUID: blockID,
              instruction: blockData.prompt || "No prompt",
              contextRefs: (blockData.context || [])
                .map((ctx) => ctx.value)
                .filter((v) => v),
              blockType,
            }),
          })
            .then((r) => r.json())
            .then((data) => {
              if (loadingIndicator) loadingIndicator.style.display = "none";
              if (blockType === "dynamic-option") {
                const options = data.reply
                  .split("\n")
                  .filter((line) => line.trim() !== "");
                const opts = options.map(
                  (opt, i) =>
                    `<div class="static-option" data-index="${i}" onclick="selectOption(this, '${blockID}', 'dynamic-option')">${opt}</div>`
                );
                container.innerHTML = opts.join("");
              } else if (blockType === "dynamic-text") {
                container.innerHTML = `<div class="dynamic-text-result">${
                  data.reply || ""
                }</div>`;
              } else if (blockType === "dynamic-word") {
                container.innerHTML = `<span class="dynamic-word">${
                  data.reply || ""
                }</span>`;
              }
            })
            .catch((err) => {
              console.error("Error in fetchDynamicBlock:", err);
              container.innerText = "Error loading dynamic content.";
              if (loadingIndicator) loadingIndicator.style.display = "none";
            });
        }

        // Move to the next passage.
        window.goToNextPassage = function (currIndex) {
          const currentEl = document.getElementById("passage-" + currIndex);
          const nextIndex = currIndex + 1;
          if (currentEl) currentEl.classList.remove("active");
          renderPassage(nextIndex);
          const nextEl = document.getElementById("passage-" + nextIndex);
          if (nextEl) {
            nextEl.classList.add("active");
            currentPassageIndex = nextIndex;
            window.scrollTo(0, 0);
          }
        };
      })();
    </script>
  </body>
</html>
