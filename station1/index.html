<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Interactive Story Player - Station 1</title>
    <link rel="stylesheet" href="station1.css?v=<?php echo time(); ?>" />
  </head>
  <body>
    <div id="player-data"></div>
    <div id="passage-container"></div>
    <div id="status-bar"></div>
    <script>
      (function () {
        // Configuration and Initialization
        const SERVER_URL = window.location.origin.replace(/:\d+$/, ":3001");
        const playerID =
          "player_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substring(2, 9);
        document.getElementById("status-bar").innerText =
          "Story Player ID: " + playerID;

        let projectBlocks = [];
        let passages = [];
        let currentPassageIndex = 0;

        // Load the story JSON
        fetch("input/story1.json?nocache=" + new Date().getTime())
          .then((response) => response.json())
          .then((data) => {
            if (data.blocks && Array.isArray(data.blocks)) {
              projectBlocks = data.blocks;
              init();
            } else {
              document.getElementById("passage-container").innerHTML =
                "<div class='error'>Error: Invalid story data</div>";
            }
          })
          .catch((error) => {
            console.error("Error loading story:", error);
            document.getElementById("passage-container").innerHTML =
              "<div class='error'>Error loading story. Please make sure story1.json exists.</div>";
          });

        function init() {
          groupBlocksIntoPassages();
          renderPassage(0);
          const firstPassage = document.getElementById("passage-0");
          if (firstPassage) {
            firstPassage.classList.add("active");
            loadDynamicContentForPassage(firstPassage);
          }
        }

        // Group blocks into passages based on scene headers.
        function groupBlocksIntoPassages() {
          let current = [];
          projectBlocks.forEach((block) => {
            if (block.type === "scene-header" && current.length > 0) {
              passages.push(current);
              current = [];
            }
            current.push(block);
          });
          if (current.length > 0) passages.push(current);
        }

        // Render a passage with its blocks.
        function renderPassage(passageIndex) {
          if (passageIndex >= passages.length) return;

          const container = document.getElementById("passage-container");
          const blocks = passages[passageIndex];
          const passageEl = document.createElement("div");
          passageEl.className = "passage";
          passageEl.id = "passage-" + passageIndex;

          blocks.forEach((block) => {
            const blockEl = document.createElement("div");
            blockEl.className = "block-" + block.type;
            blockEl.style.marginBottom = "20px";
            switch (block.type) {
              case "plain":
                blockEl.innerHTML =
                  '<div class="plain">' + (block.text || "") + "</div>";
                break;
              case "static":
                if (Array.isArray(block.options)) {
                  const opts = block.options.map(
                    (opt, i) =>
                      `<div class="static-option" data-idx="${i}" onclick="selectOption(this, '${block.id}', 'static')">${opt}</div>`
                  );
                  blockEl.innerHTML = `<div class="static-option-container">${opts.join(
                    ""
                  )}</div>`;
                }
                break;
              case "dynamic-option":
                blockEl.innerHTML = `
                  <div class="dynamic-container">
                    <div class="loading-indicator">Loading dynamic options... <span class="loading"></span></div>
                    <div class="dynamic-options-container" data-uuid="${block.id}"></div>
                  </div>`;
                break;
              case "dynamic-text":
                blockEl.innerHTML = `
                  <div class="dynamic-container">
                    <div class="loading-indicator">Generating text... <span class="loading"></span></div>
                    <div class="dynamic-text-container" data-uuid="${block.id}"></div>
                  </div>`;
                break;
              case "dynamic-word":
                blockEl.innerHTML = `
                  <div class="dynamic-container">
                    <div class="loading-indicator">Generating word... <span class="loading"></span></div>
                    <div class="dynamic-word-container" data-uuid="${block.id}"></div>
                  </div>`;
                break;
              case "scene-header":
                blockEl.innerHTML = `<h2>${block.titleName || "Scene"}</h2>`;
                break;
            }
            passageEl.appendChild(blockEl);
          });

          // Add Continue link or End message.
          if (passageIndex < passages.length - 1) {
            const link = document.createElement("div");
            link.innerHTML = `<a href="#" class="next-link" onclick="goToNextPassage(${passageIndex}); return false;">Continue</a>`;
            passageEl.appendChild(link);
          } else {
            const end = document.createElement("div");
            end.style.marginTop = "30px";
            end.style.textAlign = "center";
            end.style.fontStyle = "italic";
            end.innerText = "The End";
            passageEl.appendChild(end);
          }

          container.appendChild(passageEl);
        }

        // Load dynamic content for the given passage element only.
        function loadDynamicContentForPassage(passageElement) {
          const dynamicContainers = passageElement.querySelectorAll(
            ".dynamic-options-container, .dynamic-text-container, .dynamic-word-container"
          );
          dynamicContainers.forEach((container) => {
            let blockType = "";
            if (container.classList.contains("dynamic-options-container")) {
              blockType = "dynamic-option";
            } else if (container.classList.contains("dynamic-text-container")) {
              blockType = "dynamic-text";
            } else if (container.classList.contains("dynamic-word-container")) {
              blockType = "dynamic-word";
            }
            fetchDynamicBlock(container.dataset.uuid, blockType, container);
          });
        }

        function fetchDynamicBlock(blockID, blockType, container) {
          const blockData = projectBlocks.find((b) => b.id === blockID);
          if (!blockData) {
            container.innerText = "No block data found";
            return;
          }
          const loadingIndicator = container
            .closest(".dynamic-container")
            .querySelector(".loading-indicator");
          fetch(SERVER_URL + "/generate-dynamic", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: blockData.prompt || "",
              playerID,
              blockUUID: blockID,
              instruction: blockData.prompt || "",
              contextRefs: (blockData.context || []).filter((ctx) => ctx.value),
              blockType,
            }),
          })
            .then((r) => r.json())
            .then((data) => {
              if (loadingIndicator) loadingIndicator.style.display = "none";
              if (blockType === "dynamic-option") {
                const options = data.reply
                  .split("\n")
                  .filter((line) => line.trim() !== "");
                const opts = options.map(
                  (opt, i) =>
                    `<div class="static-option" data-index="${i}" onclick="selectOption(this, '${blockID}', 'dynamic-option')">${opt}</div>`
                );
                container.innerHTML = opts.join("");
              } else if (blockType === "dynamic-text") {
                container.innerHTML = `<div class="dynamic-text-result">${
                  data.reply || ""
                }</div>`;
              } else if (blockType === "dynamic-word") {
                container.innerHTML = `<span class="dynamic-word">${
                  data.reply || ""
                }</span>`;
              }
            })
            .catch((err) => {
              console.error("Error in fetchDynamicBlock:", err);
              container.innerText = "Error loading dynamic content.";
              if (loadingIndicator) loadingIndicator.style.display = "none";
            });
        }

        // Move to the next passage.
        window.goToNextPassage = function (currIndex) {
          const currentEl = document.getElementById("passage-" + currIndex);
          const nextIndex = currIndex + 1;
          if (currentEl) currentEl.classList.remove("active");
          renderPassage(nextIndex);
          const nextEl = document.getElementById("passage-" + nextIndex);
          if (nextEl) {
            nextEl.classList.add("active");
            currentPassageIndex = nextIndex;
            window.scrollTo(0, 0);
            loadDynamicContentForPassage(nextEl);
          }
        };

        // Helper to handle option selection (static or dynamic)
        window.selectOption = function (elem, blockID, type) {
          const container = elem.parentElement;
          const allOpts = container.querySelectorAll(".static-option");
          allOpts.forEach((o) => {
            o.classList.add("faded");
            o.onclick = null;
          });
          elem.classList.remove("faded");
          elem.classList.add("selected");
          const chosenText = elem.textContent;
          const chosenIndex =
            type === "static" ? parseInt(elem.dataset.idx) : undefined;

          fetch(SERVER_URL + "/record-choice", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              playerID,
              blockUUID: blockID,
              blockType: type,
              chosenIndex: chosenIndex,
              chosenText,
              availableOptions: Array.from(allOpts).map((x) => x.textContent),
            }),
          });
        };
      })();
    </script>
  </body>
</html>
